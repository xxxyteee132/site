function asyncGeneratorStep(e,t,r,a,i,o,n){try{var s=e[o](n),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(a,i)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(a,i){var o=e.apply(t,r);function n(e){asyncGeneratorStep(o,a,i,n,s,"next",e)}function s(e){asyncGeneratorStep(o,a,i,n,s,"throw",e)}n(void 0)}))}}var ERROR_CLASS="cli-form-field-msg",FORM_PROCESSING_CLASSES=["btn","loading","disabled"],defaultErrorMessage="^Обязательное поле",FIELDS_PATTERNS={text:{presence:!1,length:{minimum:2,message:defaultErrorMessage}},tel:{presence:!1,numericality:{message:defaultErrorMessage}},email:{presence:!1,email:{message:defaultErrorMessage}},radio:{presence:!1}},FIELDS_VALIDATION_KEYS={text:"length",tel:"numericality",email:"email",radio:"presence"},getNewElement=(e,t,r)=>{var a=document.createElement(e);return t.forEach((e=>{a.classList.add(e)})),a.textContent=r,a},convertLinkToSite=e=>e.startsWith("http")?e:"http://".concat(e),redirectTo=e=>{window.location.assign(e)},toggleRadioActive=e=>{var t=e.target,r=t.closest(".cli-radio-area"),a=t.parentElement,i=r.querySelector(".cli-radio.active");toggleActive(i),toggleActive(a)},toggleActive=e=>{if(e){var t=e.querySelector(".cli-radio__outer-item"),r=e.querySelector(".cli-radio__inner-item");e.classList.toggle("active"),t.classList.toggle("active"),r.classList.toggle("active")}},setChecked=e=>{e.querySelectorAll(".cli-radio.active").forEach((e=>{e.querySelector('input[type="radio"]').setAttribute("checked","checked")}))},init=e=>{var t=[],r=document.querySelectorAll('[data-script="form"]'),a=function(){var t=_asyncToGenerator((function*(t,r){if(t.style.display="none",Object.keys(r.dataset).includes("popupElement")){var a=e.find((e=>e.startsWith("module-button."))),{hidePopup:i}=yield import("./".concat(a));i(r)}else r.style.display="block"}));return function(e,r){return t.apply(this,arguments)}}();r.forEach((r=>{setChecked(r);var i=!!r.closest("[data-style]").querySelector('[data-script="cart"]'),o=Array.from(r.querySelectorAll("[data-radio-group]")).map((e=>e.querySelectorAll('input[type="radio"]')));r.querySelectorAll('input[type="radio"]').forEach((e=>{e.addEventListener("click",toggleRadioActive),t.push({eventTarget:e,handler:toggleRadioActive,event:"click"})}));var n=r.closest("[data-style]"),s=n.querySelector("[data-block]"),c=n.querySelector('[data-script="message"]'),l=c&&c.querySelector("[data-message-btn]"),d=c&&c.querySelector("[data-message-close]");l&&l.addEventListener("click",function(){var e=_asyncToGenerator((function*(e){e.preventDefault(),yield a(c,s)}));return function(t){return e.apply(this,arguments)}}()),d&&d.addEventListener("click",function(){var e=_asyncToGenerator((function*(e){e.preventDefault(),yield a(c,s)}));return function(t){return e.apply(this,arguments)}}());var u=r.dataset.formOptions&&JSON.parse(r.dataset.formOptions),p=(r.dataset.formContent&&JSON.parse(r.dataset.formContent)).fields,{action_type:f,redirect:y}=u.action,v=r.id,S="";"redirect_to_page"===f?S=y:"redirect_to_site"===f&&(S=convertLinkToSite(y));var m={};p.filter((e=>!e.hidden)).forEach((e=>{var t=Object.assign({},FIELDS_PATTERNS[e.type]);t.presence=!!e.required&&{message:e.data_msg_required||defaultErrorMessage,allowEmpty:!1},t[FIELDS_VALIDATION_KEYS[e.type]]&&(t[FIELDS_VALIDATION_KEYS[e.type]].message=e.invalid_message||defaultErrorMessage),m[e.id]={[e.type]:t}}));var g=Array.from(r.querySelectorAll("[data-form-field] input")),h=r.querySelector('[type="submit"]');g.forEach((e=>{e.required=p.find((t=>t.id===e.dataset.id)).required,e.addEventListener("input",(()=>{var t="radio"===e.type?e.closest("[data-radio-group]"):e.parentNode,r=t.querySelector(".".concat(ERROR_CLASS));r&&(t.removeChild(r),t.classList.remove("error"))}))}));var E=function(){var e=_asyncToGenerator((function*(){var e={PublicId:v,"Content-Type":"application/json;charset=UTF-8"},t=p.filter((e=>e.hidden))[0],a={};g.forEach((e=>{var t=e.dataset.id;("radio"!==e.type||e.checked)&&(a[t]=e.value)}));var i=localStorage.forms&&JSON.parse(localStorage.forms);t&&i&&i[r.id]&&(a[t.id]=i[r.id]),(yield fetch(window.formApi,{method:"POST",body:JSON.stringify(a),headers:e})).ok&&(r.dataset.order=""),r.reset()}));return function(){return e.apply(this,arguments)}}(),_={show_message:()=>((e,t)=>{t.style.display="none",e.style.display="block"})(c,s),redirect_to_page:()=>redirectTo(S),redirect_to_site:()=>redirectTo(S)};r.addEventListener("submit",function(){var t=_asyncToGenerator((function*(t){t.preventDefault();var r=[];if(g.filter((e=>"radio"!==e.type)).forEach((e=>{var t=e.dataset.id,a={[e.type]:""===e.value?null:e.value};r.push({result:window.validate(a,m[e.dataset.id]),fieldId:t})})),o.forEach((e=>{var t=e[0].dataset.id,a={},i=Array.from(e).some((e=>e.checked));a.radio=i||null,r.push({result:window.validate(a,m[t]),fieldId:t})})),(r=r.filter((e=>e.result))).length)r.forEach((e=>{var{result:t,fieldId:r}=e,a=g.find((e=>e.dataset.id===r)),i=a.type,o=t[i][0],n=getNewElement("div",[ERROR_CLASS],o),s="radio"===i?a.closest("[data-radio-group]"):a.parentNode,c=s.querySelector(".".concat(ERROR_CLASS));c?s.replaceChild(n,c):s.appendChild(n),s.classList.add("error")}));else try{if(h.classList.add(...FORM_PROCESSING_CLASSES),yield E(),i){var a=e.find((e=>e.startsWith("module-cart."))),{clearCart:n}=yield import("./".concat(a));n()}var s=_[f];s&&s()}catch(e){h.classList.remove(...FORM_PROCESSING_CLASSES)}}));return function(e){return t.apply(this,arguments)}}())})),window.addEventListener("beforeunload",(()=>{t.forEach((e=>{e.eventTarget.removeEventListener(e.event,e.handler)}))}))};export default init;